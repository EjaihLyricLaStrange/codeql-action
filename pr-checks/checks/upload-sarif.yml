name: "Test different uses of `upload-sarif`"
description: "Checks that uploading SARIFs to the code quality endpoint works"
versions: ["default"]
analysisKinds: ["code-scanning", "code-quality", "code-scanning,code-quality"]
installGo: true
steps:
  - uses: ./../action/init
    with:
      tools: ${{ steps.prepare-test.outputs.tools-url }}
      languages: csharp,java,javascript,python
      analysis-kinds: ${{ matrix.analysis-kinds }}
  - name: Build code
    run: ./build.sh
  # Generate some SARIF we can upload with the upload-sarif step
  - uses: ./../action/analyze
    with:
      ref: 'refs/heads/main'
      sha: '5e235361806c361d4d3f8859e3c897658025a9a2'
      upload: never

  - name: |
      Upload all SARIF files for `analysis-kinds: ${{ matrix.analysis-kinds }}`
    uses: ./../action/upload-sarif
    id: upload-sarif
    with:
      ref: 'refs/heads/main'
      sha: '5e235361806c361d4d3f8859e3c897658025a9a2'
  - name: "Check output from `upload-sarif` step for `code-scanning`"
    if: "contains(matrix.analysis-kinds, 'code-scanning') && !(fromJSON(steps.upload-sarif.outputs.sarif-ids).code-scanning)"
    run: exit 1
  - name: "Check output from `upload-sarif` step for `code-quality`"
    if: "contains(matrix.analysis-kinds, 'code-quality') && !(fromJSON(steps.upload-sarif.outputs.sarif-ids).code-quality)"
    run: exit 1
